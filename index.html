<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guess Hint Game</title>
<style>
  :root{
    --bg:#0e0f13;
    --panel:#171a21;
    --muted:#9aa4b2;
    --text:#eef2f7;
    --brand:#6ea8fe;
    --ok:#47d18c;
    --bad:#ff7373;
    --chip:#ff7373;
    --chip2:#263243;
    --border:#2a3142;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    line-height:1.6;
  }
  .container{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:24px;margin:0 0 12px}
  .subtitle{color:var(--muted);margin-bottom:18px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid{grid-template-columns: 1.1fr 1fr} }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.25);
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  label{font-weight:600}
  input[type="text"], textarea, select{
    width:100%; background:#0f131b; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:12px; font-size:16px; outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  button{
    appearance:none; border:none; border-radius:12px; padding:10px 14px; font-size:15px; font-weight:700;
    background:var(--brand); color:#081325; cursor:pointer; transition: transform .03s ease, opacity .15s ease;
  }
  button:disabled{opacity:.45; cursor:not-allowed}
  button:active{transform: translateY(1px)}
  .btn-ghost{background:transparent; border:1px solid var(--border); color:var(--text)}
  .btn-ok{background:var(--ok); color:#052615}
  .btn-bad{background:var(--bad); color:#2a0a0a}
  .btn-wide{width:100%}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    background:var(--chip2); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-weight:600; color:#d5dbea
  }
  .chip.active{background:var(--chip); color:#fff}
  .muted{color:var(--muted)}
  .title-row{display:flex; justify-content:space-between; align-items:center; gap:10px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border); text-align:left}
  th{color:#c7cfdb}
  .win{background:linear-gradient(90deg, rgba(255,215,0,.08), transparent)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .divider{height:1px; background:var(--border); margin:12px 0}
  .tag{font-size:12px; color:#cbd3e0; background:#253048; padding:2px 8px; border-radius:999px; border:1px solid var(--border)}
  .right{margin-left:auto}
  .center{text-align:center}
  .danger{color:#ff9b9b}
  .success{color:#a6f3c3}
  .hintbox{display:grid; gap:10px; grid-template-columns:1fr}
  @media(min-width:700px){ .hintbox{ grid-template-columns: 1fr 1fr } }
  small.help{display:block;color:var(--muted); margin-top:4px}
  /* ãƒ«ãƒ¼ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  .rules-card details{
  width:100%;
  }
  .rules-card summary{
  list-style:none;
  cursor:pointer;
  font-weight:700;
  display:flex; align-items:center; gap:8px;
  }
  .rules-card summary::-webkit-details-marker{ display:none; }
  .rules-card summary::after{
  content:"â–¼"; font-size:12px; opacity:.6; margin-left:auto;
  transition: transform .15s ease;
  }
  .rules-card details[open] summary::after{ transform: rotate(180deg); }
  .rules-list{
  margin-top:10px; color:var(--text);
  }
  .rules-list li + li{ margin-top:6px; }
  .rules-note{ color:var(--muted); font-size:12px; margin-top:8px; display:block; }
  /* ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .modal{
  width:min(92vw,420px); background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .modal .title-row{ margin-bottom:8px }
  .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px }
</style>
</head>
<body>
  <!-- æ–°è¦ã‚²ãƒ¼ãƒ  ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="confirmModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="newGameTitle">
    <div class="title-row">
    <strong id="newGameTitle">æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ</strong>
    </div>
    <div class="muted">
    ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆãƒ»å±¥æ­´ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚
    </div>
    <div class="actions">
    <button id="cancelNewGame" class="btn-ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button id="confirmNewGame" class="btn-bad">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
  </div>
  <div class="container">
    <h1>Guess Hint Game</h1>
    <div class="subtitle">
      <p>
        1äººã®ã€ŒGuesserï¼ˆå½“ã¦ã‚‹äººï¼‰ã€ã‚’ã€ã»ã‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ãŒ<b>â€œ1èªã ã‘ã®ãƒ’ãƒ³ãƒˆâ€</b> ã§æ­£è§£ã¸å°ãå¿ƒç†æˆ¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚²ãƒ¼ãƒ ã§ã™ã€‚
      </p>
      <p>
        ãƒ’ãƒ³ãƒˆã¯ã€Œ1ã¤ã®åè©ã¾ãŸã¯å½¢å®¹è©ã€ã ã‘ã€‚
        å°‘ãªã„ãƒ’ãƒ³ãƒˆã§å½“ã¦ã‚Œã°ã€Guesserã¯é«˜å¾—ç‚¹ï¼
      </p>
      <p>
        ãŸã ã—ã€ãƒ’ãƒ³ãƒˆã‚’å‡ºã™å´ã¯ã€ä¼ã‚ã‚Šã‚„ã™ã™ãã‚‹ã¨é«˜å¾—ç‚¹ã‚’å–ã‚‰ã‚Œã‚‹ã€‚ä¼ã‚ã‚‰ãªã•ã™ãã‚‹ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’å—ã‘ã‚‹ã€‚
        <b>ã€Œã‚®ãƒªã‚®ãƒªä¼ã‚ã‚Šãã†ãª1èªã€ã®é§†ã‘å¼•ããŒã€ã“ã®ã‚²ãƒ¼ãƒ ã®ä¸€ç•ªã®é¢ç™½ã•ã§ã™ã€‚</b>
      </p>
      <p>
        å…¨å“¡ãŒ1åº¦ãšã¤Guesserã‚’æ‹…å½“ã—ã€æœ€çµ‚çš„ã«
        ç²å¾—ãƒã‚¤ãƒ³ãƒˆ ã¨ ãƒšãƒŠãƒ«ãƒ†ã‚£
        ã§é †ä½ã‚’ç«¶ã„ã¾ã™ã€‚
      </p>
      <p>
        <b>çµ¶å¦™ãƒ’ãƒ³ãƒˆã®ã‚»ãƒ³ã‚¹ãŒå•ã‚ã‚Œã‚‹ã€æ–°æ„Ÿè¦šã®â€œè¨€è‘‰ã®æˆ¦ã„â€ã‚’æ¥½ã—ã‚‚ã†ï¼</b>
      </p>

      <button id="resetBtn" class="btn-ghost">æ–°è¦ã‚²ãƒ¼ãƒ </button>
    </div>
    <div class="card rules-card" style="margin-top:10px">
      <details id="rulesBox">
        <summary>ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ãƒ»é€²ã‚æ–¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºï¼‰</summary>
        <ol class="rules-list">
        <li>å‚åŠ ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ã®åå‰ã‚’å…¥åŠ›ã—ã€å‚åŠ é †ã‚’æ±ºã‚ã¾ã™ã€‚å…¥åŠ›ã—ãŸé †ç•ªã«å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ Guesser ãŒå·¡ã‚Šã¾ã™ã€‚ãƒ’ãƒ³ãƒˆã‚’å‡ºã™é †ç•ªã§ã‚‚ã‚ã‚Šã¾ã™ã€‚</li>
        <li>æœ€åˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ Guesserï¼ˆå½“ã¦ã‚‹äººï¼‰ã‚’æ±ºå®šã—ã¾ã™ã€‚Guesser ä»¥å¤–ã¯ â€œãƒ’ãƒ³ãƒˆå½¹â€ ã¨ãªã‚Šã¾ã™ã€‚</li>
        <li>ãƒ’ãƒ³ãƒˆå½¹ã©ã†ã—ã§ç›¸è«‡ã—ã¦ã€ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã® <b class="danger">æ­£è§£ï¼ˆåè©1ã¤ï¼‰</b> ã‚’ Guesser ã«çŸ¥ã‚‰ã‚Œãªã„ã‚ˆã†ã«æ±ºã‚ã¾ã™ã€‚</b>(æ­£è§£ä¾‹: ã€Œå¤ªé™½ã€ã€Œå¾³å·å®¶åº·ã€ãªã©)</li>
        <li>ãƒ’ãƒ³ãƒˆå½¹ã¯é †ç•ªã« <b class="danger">åè©ã¾ãŸã¯å½¢å®¹è©ã®1èªã ã‘</b> ã‚’æç¤ºã—ã€Guesser ã¯ãƒ’ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†ãŸã³ã« 1 å›ã ã‘å›ç­”ã—ã¾ã™ã€‚(ãƒ’ãƒ³ãƒˆä¾‹: ã€Œæ˜ã‚‹ã„ã€ã€Œæ­¦å£«ã€ãªã©)</li>
        <li>Guesser ãŒæ­£è§£ã—ãŸå ´åˆã€Guesserã¯ãã®æ™‚ç‚¹ã®ãƒ’ãƒ³ãƒˆæ•°ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã™ã€‚<br>
          ç²å¾—ãƒã‚¤ãƒ³ãƒˆã¯ <b class="success mono">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•° âˆ’ ãƒ’ãƒ³ãƒˆæ•°</b> ã§è¨ˆç®—ã—ã¾ã™ã€‚<br>
          <b>ãƒ’ãƒ³ãƒˆãŒå°‘ãªã„ã»ã©é«˜å¾—ç‚¹ï¼</b></li>
        <li>ãƒ’ãƒ³ãƒˆå½¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ãŒãƒ’ãƒ³ãƒˆã‚’å‡ºã—ã¦ã‚‚GuesserãŒæ­£è§£ã§ããªã‹ã£ãŸå ´åˆã€<b>ãƒ’ãƒ³ãƒˆå½¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡</b>ã« <b class="danger">ãƒšãƒŠãƒ«ãƒ†ã‚£ +1</b> ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã®æ•°ãŒå¤šã„ã»ã©ã€æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆãŒå°‘ãªããªã‚Šã¾ã™ã€‚</li>
        <li>ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å¾Œã€<b>ã€Œå¯©è­°ã€</b>ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ä»»æ„ã«å¢—æ¸›ã§ãã¾ã™ã€‚<br>
          å…¨å“¡ã§è©±ã—åˆã„ã€ã‚ˆããªã‹ã£ãŸãƒ’ãƒ³ãƒˆã«ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ä¸ãˆã‚‹ãªã©ã€å¯©è­°ã—ã¦ãã ã•ã„ã€‚<br>
          1 ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã”ã¨ã«ã€å¯©è­°ã¯ 1 å›è¡Œã„ã¾ã™ã€‚</li>
        <li>æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯ã€å‚åŠ é †ã«æ²¿ã£ã¦æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ Guesser ã¨ãªã‚Šã€åŒã˜æµã‚Œã§é€²è¡Œã—ã¾ã™ã€‚</li>
        <li>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ãŒ1å›ãšã¤ Guesser ã‚’æ‹…å½“ã—ãŸã‚‰ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚<br>
          æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆã¯ <b class="success mono">ç²å¾—ãƒã‚¤ãƒ³ãƒˆã«ãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡ã‚’ãƒšãƒŠãƒ«ãƒ†ã‚£ã®æ•°ã ã‘æ›ã‘ç®—ã—ã¦</b> è¨ˆç®—ã—ã¾ã™ã€‚<br>
          (ä¾‹: ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ10ç‚¹ã§ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒ +2 ã€ãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡ãŒ 0.5 ã®æ™‚ã¯ã€10 Ã— 0.5 Ã— 0.5 = 2.5ç‚¹)<br>
          ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒå¤šã„ã»ã©ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒæ¸›ã£ã¦ã„ãã¾ã™ã€‚</li>
        <li>é †ä½ã¯æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆãŒé«˜ã„é †ã€‚åŒç‚¹ã®å ´åˆã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ã®å°‘ãªã„æ–¹ã€ã•ã‚‰ã«åŒã˜ãªã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é †ãŒæ—©ã„æ–¹ãŒä¸Šä½ã§ã™ã€‚</li>
        </ol>
        <span class="rules-note">â€» Guesser ã«æ­£è§£ãŒè¦‹ãˆãªã„ã‚ˆã†ã€æ­£è§£å…¥åŠ›æ™‚ã¯ç”»é¢ã‚’éš ã™ãªã©é‹ç”¨ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</span>
      </details>
    </div>

    <!-- è¨­å®š -->
    <div id="setup" class="card">
      <div class="title-row"><strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²</strong></div>
      <div class="row">
        <div style="flex:1 1 300px">
          <label for="names">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆ1è¡Œã«ã¤ã1äººã®åå‰ã‚’å…¥åŠ›ï¼‰</label>
          <textarea id="names" placeholder="ã‚µãƒ³ãƒ—ãƒ«
çŸ³ç”°
æŸ´ç”°
è‹¥æ—
å±±å†…
"></textarea>
          <small class="help">â€» 2äººä»¥ä¸Šå¿…é ˆã€‚ç©ºè¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</small>
          <small class="danger">â€» å…¥åŠ›ã—ãŸé †ç•ªã§ãƒ©ã‚¦ãƒ³ãƒ‰å†…ãŒé€²ã¿ã¾ã™ï¼å¾Œã‹ã‚‰é †ç•ªã¯å¤‰ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚</small>
        </div>
        <div style="flex:1 1 260px">
          <label for="starter">æœ€åˆã®Guesser</label>
          <select id="starter"><option value="">ï¼ˆä¸Šã®åå‰ã‚’å…¥ã‚Œã‚‹ã¨é¸ã¹ã¾ã™ï¼‰</option></select>
          <small class="help">è‡ªå‹•çš„ã«å…ˆé ­ã®äººãŒæœ€åˆã®Guesserã¨ã—ã¦é¸æŠã•ã‚Œã¾ã™ã€‚</small>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div style="flex:1 1 260px">
          <label for="penaltyBase">ãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡ï¼ˆ0.5ã€œ1.0ï¼‰</label>
          <input id="penaltyBase" type="number" min="0.5" max="1.0" step="0.05" value="0.8" />
          <small class="help">
            <b>ã€ŒãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡ã€ãŒå°ã•ã„ã»ã©ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé‡ããªã‚Šã¾ã™ã€‚</b><br>
            ã‚†ã‚‹ã„: 0.95<br>
            ãµã¤ã†: 0.8<br>
            ãã¤ã„: 0.5
          </small>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="startBtn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button id="fillDemo" class="btn-ghost">ã‚µãƒ³ãƒ—ãƒ«ã‚’å…¥ã‚Œã‚‹</button>
      </div>
    </div>

    <div class="grid" style="margin-top:16px; display:none" id="playArea">
      <!-- å³ï¼šé€²è¡Œ -->
      <div class="card" id="flowCard">
        <div class="title-row">
          <strong>ãƒ©ã‚¦ãƒ³ãƒ‰ <span id="roundNow">1</span>/<span id="roundMax">â€“</span></strong>
          <span class="tag" id="phaseTag">æ­£è§£å…¥åŠ›</span>
        </div>
        <div class="divider"></div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—ï¼šæ­£è§£ -->
        <div id="secretStep">
          <div class="row">
            <div class="chip active">Guesserï¼š<strong id="guesserName"></strong></div>
            <div class="chips" id="providerChips"></div>
          </div>
          <div style="margin-top:10px">
            <label for="secretInput">ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®æ­£è§£ï¼ˆåè©ï¼‰</label>
            <input id="secretInput" type="text" placeholder="æ­£è§£ï¼ˆåè©ï¼‰" />
            <small class="danger">Guesserã«è¦‹ã‚‰ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ï¼</small>
            <div class="row" style="margin-top:8px">
              <button id="lockSecret" class="">æ­£è§£ã‚’ç¢ºå®š</button>
            </div>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—ï¼šãƒ’ãƒ³ãƒˆï¼†å›ç­” -->
        <div id="hintStep" style="display:none">
          <div class="row">
            <div class="chip active">Guesserï¼š<strong id="AName"></strong></div>
            <div class="chip">ãƒ’ãƒ³ãƒˆå½¹ï¼š<strong id="currentProvider"></strong></div>
            <div class="chip">ãƒ’ãƒ³ãƒˆç•ªå·ï¼š<span id="hintCount">1</span></div>
          </div>
          <div class="hintbox" style="margin-top:12px">
            <div>
              <label for="hintInput">Hint</label>
              <input id="hintInput" type="text" placeholder="ãƒ’ãƒ³ãƒˆã‚’å…¥åŠ›" />
            </div>
            <div>
              <label for="guessInput">Guess</label>
              <input id="guessInput" type="text" placeholder="Guesserã®å›ç­”ã‚’å…¥åŠ›" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="markCorrect" class="btn-ok">æ­£è§£ï¼</button>
            <button id="markWrong" class="btn-bad">ä¸æ­£è§£ï¼ˆæ¬¡ã®ãƒ’ãƒ³ãƒˆå½¹ã¸ï¼‰</button>
          </div>
          <div id="pointsPreview" class="muted" style="margin-top:6px"></div>
        </div>

        <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ -->
        <div id="roundResult" style="display:none; margin-top:8px">
          <div id="roundSummary"></div>
          <div id="manualPenalty" style="margin-top:10px"></div>
          <div class="row" style="margin-top:8px">
            <button id="nextRound" class="btn-wide">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ â†’</button>
          </div>
        </div>
      </div>

      <!-- å·¦ï¼šãƒã‚¤ãƒ³ãƒˆï¼†å±¥æ­´ -->
      <div class="card">
        <div class="title-row">
          <strong>ãƒã‚¤ãƒ³ãƒˆãƒœãƒ¼ãƒ‰</strong>
        </div>
        <div class="divider"></div>
        <table id="scoreTable">
          <thead>
            <tr><th>#</th><th>åå‰</th><th class="mono">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ<sup>â€»1</sup></th><th>ãƒšãƒŠãƒ«ãƒ†ã‚£</th><th class="mono">æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ<sup>â€»2</sup></th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <small class="help">â€»1 ç²å¾—ãƒã‚¤ãƒ³ãƒˆ = ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•° - ãƒ’ãƒ³ãƒˆæ•°<br>â€»2 æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ = ç²å¾—ãƒã‚¤ãƒ³ãƒˆ Ã— ãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡<sup>ãƒšãƒŠãƒ«ãƒ†ã‚£æ•°</sup><br>ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«ç¢ºå®šã—ã¦é †ä½ä»˜ã‘ã—ã¾ã™ã€‚</small>

        <div class="divider"></div>
        <!-- ä»Šãƒ©ã‚¦ãƒ³ãƒ‰ã®å±¥æ­´ -->
        <div class="title-row"><strong>ä»Šãƒ©ã‚¦ãƒ³ãƒ‰ã®å±¥æ­´</strong><span class="muted" id="curHistMeta"></span></div>
        <div id="currentHistory"></div>

        <div class="divider"></div>
        <!-- éå»ãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´ï¼ˆãƒˆã‚°ãƒ«è¡¨ç¤ºï¼‰ -->
        <div class="title-row">
          <strong>éå»ãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´</strong>
          <button id="togglePastHistory" class="btn-ghost">è¡¨ç¤º</button>
        </div>
        <div id="pastHistoryWrap" style="display:none">
          <span class="muted" id="historyCount"></span>
          <div id="history" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- æœ€çµ‚çµæœ -->
    <div id="finalArea" class="card" style="display:none; margin-top:16px">
      <div class="title-row">
        <strong>æœ€çµ‚çµæœ</strong>
        <span class="tag">ã‚²ãƒ¼ãƒ çµ‚äº†</span>
      </div>
      <div class="divider"></div>
      <div id="finalWinner" class="center" style="font-size:18px; margin-bottom:8px"></div>
      <table id="finalTable">
        <thead>
          <tr><th>é †ä½</th><th>åå‰</th><th class="mono">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</th><th>ãƒšãƒŠãƒ«ãƒ†ã‚£</th><th class="mono">æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ</th><th class="muted">ï¼ˆåˆæœŸé †ï¼‰</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:12px">
        <button id="playAgain" class="btn-wide">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
      </div>
    </div>

  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const state = {
    players: [], // {name, raw:0, pen:0, order}
    roundIndex: 0,
    guesserIdx: 0,
    providers: [],
    hintTurn: 0,
    secret: "",
    steps: [], // {provider, hint, guess, correct}
    logs: [],  // éå»ãƒ©ã‚¦ãƒ³ãƒ‰
    showPastHistory: false,
    started: false,
    finished: false,
    penaltyBase: 0.8
  };

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function fmt(n){ if (Number.isInteger(n)) return String(n); const s=(Math.round(n*100)/100).toFixed(2); return s.replace(/\.00$/,'').replace(/0$/,''); }
  function computeProviders(guesserIdx){
    const N = state.players.length, arr=[];
    for(let i=1;i<N;i++) arr.push((guesserIdx+i)%N);
    return arr;
  }
  const currentA = ()=> state.players[state.guesserIdx];
  const currentProviderIdx = ()=> state.providers[state.hintTurn];
  const currentProvider = ()=> state.players[currentProviderIdx()];
  const hintCountSoFar = ()=> state.hintTurn + 1;
  const calcPointsOnCorrect = ()=> state.players.length - hintCountSoFar();
  function updateStarterOptions(){
    const names = parseNames(); const sel = $("starter"); sel.innerHTML = "";
    if (names.length===0){ sel.innerHTML = `<option value="">ï¼ˆä¸Šã®åå‰ã‚’å…¥ã‚Œã‚‹ã¨é¸ã¹ã¾ã™ï¼‰</option>`; return; }
    names.forEach((nm,i)=>{ const op=document.createElement("option"); op.value=i; op.textContent=nm; sel.appendChild(op); });
    sel.value="0";
  }
  function parseNames(){ return $("names").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

  // --- UI ---
  function renderScoreboard(){
    const tbody = $("scoreTable").querySelector("tbody"); 
    tbody.innerHTML="";
    state.players.forEach(p=>{
      const base = state.penaltyBase || 0.8;
      const final = (p.raw||0) * Math.pow(base, p.pen || 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p.order+1}</td><td>${p.name}</td><td class="mono">${fmt(p.raw||0)}</td><td>${p.pen||0}</td><td class="mono">${fmt(final)}</td>`;
      tbody.appendChild(tr);
    });
  }
  function renderProvidersChips(){
    const wrap = $("providerChips"); wrap.innerHTML="";
    state.providers.forEach(idx=>{
      const span=document.createElement("span");
      span.className="chip";
      span.textContent="ãƒ’ãƒ³ãƒˆå½¹ : " + state.players[idx].name;
      wrap.appendChild(span);
    });
  }
  function setPhaseTag(t){ $("phaseTag").textContent = t; }

  function renderSecretStep(){
    $("roundNow").textContent = state.roundIndex+1;
    $("roundMax").textContent = state.players.length;
    $("guesserName").textContent = currentA().name;
    renderProvidersChips();
    $("secretInput").value = state.secret;
    setPhaseTag("æ­£è§£å…¥åŠ›");
    $("secretStep").style.display = "";
    $("hintStep").style.display = "none";
    $("roundResult").style.display = "none";
    renderCurrentRoundHistory();
  }
  function renderHintStep(){
    $("AName").textContent = currentA().name;
    $("currentProvider").textContent = currentProvider().name;
    $("hintCount").textContent = hintCountSoFar();
    $("hintInput").value = "";
    $("guessInput").value = "";
    $("pointsPreview").textContent = `ã“ã®ãƒ’ãƒ³ãƒˆã§æ­£è§£ãªã‚‰ Guesser ${currentA().name} ã¯ ${fmt(calcPointsOnCorrect())} ç‚¹ã‚²ãƒƒãƒˆï¼`;
    setPhaseTag("ãƒ’ãƒ³ãƒˆï¼†å›ç­”");
    $("secretStep").style.display = "none";
    $("hintStep").style.display = "";
    $("roundResult").style.display = "none";
    renderCurrentRoundHistory();
    $("hintInput").focus();
  }
  function renderRoundResult(summaryHtml){
    $("roundSummary").innerHTML = summaryHtml;
    setPhaseTag("ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ");
    $("secretStep").style.display = "none";
    $("hintStep").style.display = "none";
    $("roundResult").style.display = "";
    renderManualPenaltyPanel();
  }

  function renderManualPenaltyPanel(){
    const wrap = $("manualPenalty");
    if(!wrap) return;

    let rows = state.players.map((p, i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${p.name}</td>
        <td class="mono">${fmt(p.raw||0)}</td>
        <td class="mono">${p.pen||0}</td>
        <td style="width:130px">
          <input type="number" id="penInput-${i}" class="pen-input" step="1" value="0"
                style="width:100%;text-align:right" placeholder="ä¾‹: -1 / 2">
        </td>
      </tr>
    `).join("");

    wrap.innerHTML = `
      <div class="divider"></div>
      <div>
        <summary>å¯©è­°</summary>
        <small class="muted" style="margin:8px 0 6px">
          ä»»æ„ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’å¢—æ¸›ã§ãã¾ã™ã€‚å¤‰æ›´å¾Œã€ŒãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’é©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚
        </small>
        <small class="danger">ãƒ©ã‚¦ãƒ³ãƒ‰å†…ã§å¤‰æ›´ã‚’é©ç”¨ã§ãã‚‹ã®ã¯ä¸€åº¦ã®ã¿ã§ã™ã€‚</small>
        <table style="width:100%; border-collapse:collapse">
          <thead>
            <tr><th>#</th><th>åå‰</th><th class="mono">ç²å¾—Pt</th><th>ç¾ãƒšãƒŠãƒ«ãƒ†ã‚£</th><th>å¢—æ¸›</th></tr>
          </thead>
          <tbody>${rows || ''}</tbody>
        </table>
        <div id="manualPenaltyActions" class="row" style="margin-top:10px; justify-content:flex-end">
          <button id="applyManualPenalty" class="btn-bad">ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’é©ç”¨</button>
        </div>
        <div id="manualPenaltyMsg" class="muted" style="margin-top:6px"></div>
      </div>
    `;

    $("applyManualPenalty").addEventListener("click", ()=>{
      const changes = [];
      const errors = [];

      state.players.forEach((p, i)=>{
        const el = $("penInput-" + i);
        if(!el) return;
        const raw = el.value.trim();
        if(raw === "" || raw === "0") return;          // 0 or ç©º â†’ ä½•ã‚‚ã—ãªã„
        const v = Number(raw);
        if(!Number.isFinite(v) || !Number.isInteger(v)){
          errors.push(`${p.name}: æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: -2, -1, 1, 2ï¼‰`);
          return;
        }
        p.pen = (p.pen||0) + v;                         // Â±åŠ ç®—
        changes.push({ idx:i, delta:v });
      });

      if(errors.length){
        $("manualPenaltyMsg").innerHTML = `<span class="danger">${errors.join(" / ")}</span>`;
        return;
      }
      if(changes.length === 0){
        $("manualPenaltyMsg").textContent = "é©ç”¨ã™ã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æ›´æ–°
      renderScoreboard();

      // ç›´è¿‘ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒ­ã‚°ã«è¿½è¨˜ï¼ˆå±¥æ­´ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
      const last = state.logs[state.logs.length - 1];
      if(last){
        if(!last.manualPenalties) last.manualPenalties = [];
        changes.forEach(ch => last.manualPenalties.push(ch));
        renderHistory();
      }

      // å…¥åŠ›ã‚’0ã«æˆ»ã™
      state.players.forEach((_, i)=>{
        const el = $("penInput-" + i);
        if(el) el.value = 0;
      });

      const msg = changes
        .map(ch => `${state.players[ch.idx].name} ${(ch.delta>=0?'+':'')}${ch.delta}`)
        .join(" / ");
      $("manualPenaltyMsg").innerHTML = `å¯©è­°çµæœï¼š${msg}`;
      // === ã“ã“ã‹ã‚‰ãƒ­ãƒƒã‚¯å‡¦ç† ===
      // å…¥åŠ›æ¬„ã‚’ç·¨é›†ä¸å¯ã«
      document.querySelectorAll("#manualPenalty .pen-input, .pen-input").forEach(el=>{
        el.setAttribute("disabled","disabled");
      });
  
      // ãƒœã‚¿ãƒ³ã‚’æ¶ˆã—ã¦ã€ç¢ºå®šè¡¨ç¤ºã«å·®ã—æ›¿ãˆ
      const actions = $("manualPenaltyActions");
      if (actions) {
        actions.innerHTML = `<span class="muted">ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®å¯©è­°ã¯ <strong>ç¢ºå®š</strong> ã—ã¾ã—ãŸã€‚ãƒã‚¤ãƒ³ãƒˆãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸é€²ã‚“ã§ãã ã•ã„ã€‚</span>`;
      }
    });
  }

  // ä»Šãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´
  function renderCurrentRoundHistory(){
    const box = $("currentHistory"); const meta = $("curHistMeta");
    if(!state.started){ meta.textContent=""; box.innerHTML='<span class="muted">ï¼ˆã¾ã é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ï¼‰</span>'; return; }
    const provNames = state.providers.map(i=>state.players[i].name).join(" â†’ ");
    meta.textContent = `Guesser: ${currentA().name} , ãƒ’ãƒ³ãƒˆå½¹: ${provNames}`;
    if(state.steps.length===0){ box.innerHTML='<span class="muted">ï¼ˆã¾ã å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>'; return; }
    box.innerHTML = state.steps.map((st,i)=>`
      <div class="row" style="gap:6px">
        <span class="tag">#${i+1}</span>
        <span class="chip">${state.players[st.provider].name} ã®ãƒ’ãƒ³ãƒˆ</span>
        <span class="muted">ã€Œ${escapeHtml(st.hint||"")}ã€</span>
        <span>â†’ã€Œ${escapeHtml(st.guess||"")}ã€</span>
        ${st.correct?`<span class="success">æ­£è§£</span>`:`<span class="danger">âŒä¸æ­£è§£</span>`}
      </div>
    `).join("");
  }

  // éå»ãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´
  function renderHistory(){
    const box = $("history"); box.innerHTML="";
    $("historyCount").textContent = `${state.logs.length}ä»¶`;
    state.logs.forEach((log,i)=>{
      const provNames = log.providers.map(idx=>state.players[idx].name);
      const stepsHtml = log.steps.map((st,k)=>`
        <div class="row" style="gap:6px">
          <span class="tag">#${k+1}</span>
          <span class="chip">${state.players[st.provider].name} ã®ãƒ’ãƒ³ãƒˆ</span>
          <span class="muted">ã€Œ${escapeHtml(st.hint||"")}ã€</span>
          <span>â†’ã€Œ${escapeHtml(st.guess||"")}ã€</span>
          ${st.correct?`<span class="success">æ­£è§£</span>`:`<span class="danger">ä¸æ­£è§£</span>`}
        </div>`).join("");
      const card=document.createElement("div");
      card.className="card"; card.style.padding="12px"; card.style.marginTop="10px";
      card.innerHTML = `
        <div class="title-row">
          <strong>ãƒ©ã‚¦ãƒ³ãƒ‰${i+1} Guesser: ${log.guesser}</strong>
          <span class="muted">ãƒ’ãƒ³ãƒˆå½¹ï¼š${provNames.join(" â†’ ")}</span>
        </div>
        <div class="divider"></div>
        <div>æ­£è§£ï¼š<span class="mono">${escapeHtml(log.secret)}</span></div>
        <div style="margin-top:6px">${stepsHtml || '<span class="muted">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</span>'}</div>
        <div class="divider"></div>
        <div>${log.success
          ? `ğŸ‰ æ­£è§£ï¼ Guesser ${log.guesser} ã« <strong>${fmt(log.points)}</strong> ç‚¹`
          : `âŒ ä¸æ­£è§£ã€‚ãƒ’ãƒ³ãƒˆå½¹å…¨å“¡ ã« <strong>+1</strong> ãƒšãƒŠãƒ«ãƒ†ã‚£`}
        ${log.manualPenalties && log.manualPenalties.length ? `
          <div class="divider"></div>
          <div>æ‰‹å‹•ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼š
            ${log.manualPenalties.map(mp => {
              const s = (mp.delta >= 0 ? "+" : "") + mp.delta;
              return `${state.players[mp.idx].name} ã« <strong>${s}</strong>`;
            }).join(" / ")}
          </div>
        ` : ``}
        </div>`;
      box.appendChild(card);
    });
  }
  function updatePastHistoryDisplay(){
    $("pastHistoryWrap").style.display = state.showPastHistory ? "" : "none";
    $("togglePastHistory").textContent = state.showPastHistory ? "éš ã™" : "è¡¨ç¤º";
  }

  // --- é€²è¡Œ ---
  function startGame(names, starterIdx){
    state.players = names.map((name,i)=>({name, raw:0, pen:0, order:i}));
    starterIdx = clamp(Number(starterIdx ?? 0), 0, state.players.length-1);
    state.roundIndex = 0;
    state.guesserIdx = starterIdx;
    state.providers = computeProviders(state.guesserIdx);
    state.hintTurn = 0;
    state.secret = "";
    state.steps = [];
    state.logs = [];
    state.showPastHistory = false;
    state.started = true; state.finished = false;

    $("setup").style.display = "none";
    $("playArea").style.display = "grid";
    renderScoreboard();
    renderSecretStep();
    renderHistory();
    updatePastHistoryDisplay();
  }

  function lockSecret(){
    const s = $("secretInput").value.trim();
    if(!s){ alert("æ­£è§£ï¼ˆåè©ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    state.secret = s;
    renderHintStep();
  }

  function onCorrect(){
    const hint = $("hintInput").value.trim();
    const guess = $("guessInput").value.trim();
    if(!hint || !guess){ alert("ãƒ’ãƒ³ãƒˆã¨å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const provider = currentProviderIdx();
    const points = calcPointsOnCorrect();
    currentA().raw += points;

    state.steps.push({provider, hint, guess, correct:true});
    renderCurrentRoundHistory();

    state.logs.push({
      round: state.roundIndex+1,
      guesser: currentA().name,
      providers: [...state.providers],
      secret: state.secret,
      steps: [...state.steps],
      success: true,
      points
    });

    renderScoreboard();
    renderHistory();

    const summary = `
      <div class="success">ğŸ‰ æ­£è§£ï¼ Guesserã€${currentA().name}ã€ã« <strong>${fmt(points)}</strong> ç‚¹</div>
      <small class="muted">ç²å¾—ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${state.players.length}äºº, ãƒ’ãƒ³ãƒˆæ•° ${hintCountSoFar()}<br>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•° - ãƒ’ãƒ³ãƒˆæ•° = ${state.players.length} âˆ’ ${hintCountSoFar()} = ${fmt(points)}</small>`;
    renderRoundResult(summary);
  }

  function onWrong(){
    const hint = $("hintInput").value.trim();
    const guess = $("guessInput").value.trim();
    if(!hint || !guess){ alert("ãƒ’ãƒ³ãƒˆã¨å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const provider = currentProviderIdx();
    state.steps.push({provider, hint, guess, correct:false});
    renderCurrentRoundHistory();

    if(state.hintTurn < state.providers.length - 1){
      state.hintTurn++;
      renderHintStep();
      return;
    }

    // å…¨å“¡æç¤ºã§ã‚‚ä¸æ­£è§£ â†’ ãƒ’ãƒ³ãƒˆå½¹å…¨å“¡ã«+1ãƒšãƒŠ
    state.providers.forEach(idx => { state.players[idx].pen = (state.players[idx].pen||0) + 1; });

    state.logs.push({
      round: state.roundIndex+1,
      guesser: currentA().name,
      providers: [...state.providers],
      secret: state.secret,
      steps: [...state.steps],
      success: false
    });

    renderScoreboard();
    renderHistory();

    const provNames = state.providers.map(i=>state.players[i].name).join("ã€");
    const summary = `
      <div class="danger">âŒ å…¨å“¡ã®ãƒ’ãƒ³ãƒˆã§ã‚‚Guesserã¯æ­£è§£ã§ããšâ€¦</div>
      <div>ãƒ’ãƒ³ãƒˆå½¹ <strong>${provNames}</strong> ã« <strong>+1</strong> ãƒšãƒŠãƒ«ãƒ†ã‚£</div>`;
    renderRoundResult(summary);
  }

  function nextRound(){
    state.roundIndex++;
    if(state.roundIndex >= state.players.length){ finishGame(); return; }
    state.guesserIdx = state.providers[0];
    state.providers = computeProviders(state.guesserIdx);
    state.hintTurn = 0;
    state.secret = "";
    state.steps = [];
    renderScoreboard();
    renderSecretStep();
  }

  function finishGame(){
    state.started=false; state.finished=true;
    const base = state.penaltyBase || 0.8;
    const ranked = state.players.map(p=>({...p, final: (p.raw||0) * Math.pow(base, p.pen || 0)}))
      .sort((a,b)=> b.final-a.final || a.pen-(b.pen) || a.order-b.order);
    $("playArea").style.display="none";
    $("finalArea").style.display="";

    const tbody = $("finalTable").querySelector("tbody"); tbody.innerHTML="";
    ranked.forEach((p,i)=>{
      const tr=document.createElement("tr"); if(i===0) tr.classList.add("win");
      tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td class="mono">${fmt(p.raw||0)}</td><td>${p.pen||0}</td><td class="mono">${fmt(p.final)}</td><td class="muted">${p.order+1}</td>`;
      tbody.appendChild(tr);
    });
    const champ = ranked[0];
    $("finalWinner").innerHTML = `ğŸ† å„ªå‹ï¼š<strong>${champ.name}</strong> ï¼ˆæœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ <span class="mono">${fmt(champ.final)}</span>ï¼‰`;
  }

  function resetAll(){
    state.players=[]; state.logs=[]; state.steps=[]; state.showPastHistory=false;
    state.started=false; state.finished=false;
    $("setup").style.display=""; $("playArea").style.display="none"; $("finalArea").style.display="none";
    $("names").value=""; $("starter").innerHTML=`<option value="">ï¼ˆä¸Šã®åå‰ã‚’å…¥ã‚Œã‚‹ã¨é¸ã¹ã¾ã™ï¼‰</option>`;
    $("currentHistory").innerHTML=""; $("curHistMeta").textContent="";
    updatePastHistoryDisplay();
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
  $("names").addEventListener("input", updateStarterOptions);
  $("fillDemo").addEventListener("click", ()=>{ $("names").value="çŸ³ç”°\næŸ´ç”°\nå±±å†…\nè‹¥æ—"; updateStarterOptions(); });
  $("startBtn").addEventListener("click", ()=>{
    const names=parseNames(); if(names.length<2){ alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯2äººä»¥ä¸ŠãŒå¿…è¦ã§ã™"); return; }
    const mRaw = $("penaltyBase").value;
    const m = Number(mRaw);
    if (!Number.isFinite(m) || m < 0.5 || m > 1.0) {
      alert("ãƒšãƒŠãƒ«ãƒ†ã‚£å€ç‡ ã¯ 0.5ã€œ1.0 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    state.penaltyBase = m;
    const starterVal=$("starter").value; const starterIdx=starterVal===""?0:Number(starterVal); startGame(names, starterIdx);
  });

  $("lockSecret").addEventListener("click", lockSecret);
  $("markCorrect").addEventListener("click", onCorrect);
  $("markWrong").addEventListener("click", onWrong);
  $("nextRound").addEventListener("click", nextRound);
  // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function openConfirmModal(){
    const m = $("confirmModal");
    if(!m) return;
    m.style.display = "flex";
    m.setAttribute("aria-hidden","false");
    // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ã€Œãƒªã‚»ãƒƒãƒˆã€ã¸
    $("confirmNewGame")?.focus();
  }
  function closeConfirmModal(){
    const m = $("confirmModal");
    if(!m) return;
    m.style.display = "none";
    m.setAttribute("aria-hidden","true");
    // å…ƒã®ãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
    $("resetBtn")?.focus();
  }

  // ã€Œæ–°è¦ã‚²ãƒ¼ãƒ ã€ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  $("resetBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    openConfirmModal();
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³
  $("confirmNewGame").addEventListener("click", ()=>{
    closeConfirmModal();
    resetAll();           // â† æ—¢å­˜ã®å‡¦ç†ã‚’å®Ÿè¡Œ
  });
  $("cancelNewGame").addEventListener("click", ()=>{
    closeConfirmModal();  // ä½•ã‚‚ã—ãªã„ã§é–‰ã˜ã‚‹
  });

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã‚„ ESC ã§ã‚‚é–‰ã˜ã‚‹
  $("confirmModal").addEventListener("click", (e)=>{
    if(e.target === $("confirmModal")) closeConfirmModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && $("confirmModal")?.style.display === "flex"){
      closeConfirmModal();
    }
  });

  $("playAgain").addEventListener("click", resetAll);

  $("togglePastHistory").addEventListener("click", ()=>{ state.showPastHistory=!state.showPastHistory; updatePastHistoryDisplay(); });

  // ä»»æ„ï¼šEnterã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æˆ»ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
  // $("secretInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); lockSecret(); }});
  // $("guessInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); onCorrect(); }});

})();
</script>
</body>
</html>
